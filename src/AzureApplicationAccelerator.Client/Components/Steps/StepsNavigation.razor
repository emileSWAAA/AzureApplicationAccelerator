@using System.ComponentModel.DataAnnotations
@using AzureApplicationAccelerator.Elements
@using AzureApplicationAccelerator.Shared.Validators
@inject UIDefinitionService DefinitionService
@inject IDialogService DialogService
@inject IToastService ToastService

<FluentTabs @bind-ActiveTabId="@SelectedTabId"
            OnTabClose="@RemoveTab"
            Size="TabSize.Large"
            OnTabChange="@((tab) => SelectStep(tab))">
    <FluentTab @key="@DefinitionService.Definition.Parameters.Basics.Name"
               Label="@AzureResourceUIConstants.CreateUiDefinition.Steps.BasicsName"
               Id="@($"step_{AzureResourceUIConstants.CreateUiDefinition.Steps.BasicsId}")"
               Data="@DefinitionService.Definition.Parameters.Basics" />

    @foreach (var step in DefinitionService.Definition.Parameters.Steps)
    {
        <FluentTab @bind-Label="@step.Name" Id="@($"step_{step.Id.ToString()}")" />
    }

    <div slot="start">
        <FluentButton OnClick="@OpenDialogAsync"
                      IconStart="@(new Icons.Regular.Size24.AddCircle())"
                      Appearance="Appearance.Accent" />
    </div>
</FluentTabs>

@code {
    public string SelectedTabId = $"step_{AzureResourceUIConstants.CreateUiDefinition.Steps.BasicsId}";

    private FluentTabs _fluentTabs = default!;

    private async Task SelectStep(FluentTab tab)
    {
        // Logic to change the active step can be added here
        var activeTab = tab;
        if (activeTab is null || activeTab.Label.Equals(DefinitionService.ActiveStep.Name, StringComparison.OrdinalIgnoreCase))
        {
            return;
        }

        Guid stepId = Guid.Parse(activeTab.Id.Split('_')[1]);
        await DefinitionService.SetActiveStepAsync(stepId);
    }

    private async Task RemoveTab(FluentTab tabPanel)
    {
        if (tabPanel is null)
        {
            // TODO: snackbar error
            return;
        }

        if (DefinitionService.ActiveStep is not null)
        {
            await DefinitionService.RemoveStepAsync(DefinitionService.ActiveStep.Id);
        }
    }

    private async Task OpenDialogAsync()
    {
        DialogParameters parameters = new()
        {
            Title = "Create a new step",
            PrimaryAction = "Save",
            PrimaryActionEnabled = true,
            SecondaryAction = "No",
            Width = "500px",
            PreventScroll = true
        };

        var newName = new DialogContent() { Title = string.Empty };
        var dialog = await DialogService.ShowDialogAsync<NewStepDialog>(newName, parameters);
        var result = await dialog.Result as DialogResult;
        if (result?.Data is not null)
        {
            var res = result.Data as DialogContent;
            var tabName = res.Title;
            if (DefinitionService.Definition.Parameters.Steps.Any(s => s.Name.Equals(tabName, StringComparison.OrdinalIgnoreCase)))
            {
                ToastService.ShowError("A step with this name already exists. Please choose a different name.");
                return;
            }

            await DefinitionService.AddStepAsync(new StepDto() { Title = res.Title, Label = res.Label});
        }
        else
        {
            Console.WriteLine($"Dialog closed - Canceled: {result.Cancelled}");
        }
    }

    public class DialogContent
    {
        [StepValidator]
        public string Title { get; set; } = string.Empty;

        public string Label { get; set; } = string.Empty;
    }
}
